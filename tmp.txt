import json
import re
import sys

def extract_questions(output_str):
    """从输出字符串中提取所有问题文本"""
    # 匹配所有"question"字段的正则表达式
    pattern = r'"question":\s*"((?:[^"\\]|\\.)*)"'
    matches = re.findall(pattern, output_str, re.DOTALL)
    
    questions = []
    for match in matches:
        try:
            # 处理转义字符并提取问题文本
            question_text = json.loads(f'"{match}"')
            questions.append(question_text)
        except Exception as e:
            print(f"处理问题文本时出错: {str(e)}", file=sys.stderr)
            questions.append(match)  # 保留原始文本
    
    return questions

def process_json_file(input_file, output_file):
    """处理JSON文件并输出问题列表"""
    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        all_questions = []
        
        # 处理每个output项
        for item in data:
            if 'output' in item:
                questions = extract_questions(item['output'])
                all_questions.extend(questions)
        
        # 写入输出文件
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(all_questions, f, ensure_ascii=False, indent=2)
        
        print(f"成功提取{len(all_questions)}个问题并保存到: {output_file}")
        return True
    
    except FileNotFoundError:
        print(f"错误：文件未找到 - {input_file}", file=sys.stderr)
    except json.JSONDecodeError as e:
        print(f"JSON解析错误: {str(e)}", file=sys.stderr)
    except Exception as e:
        print(f"处理失败: {str(e)}", file=sys.stderr)
    
    return False

# 使用示例
if __name__ == "__main__":
    input_json = "input.json"  # 输入JSON文件路径
    output_json = "questions.json"  # 输出JSON文件路径
    process_json_file(input_json, output_json)
